"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2020.7.29"
__checksum__ = "5487f10a66098febb92d00c848095772604edfad667b39ea9d89a3d598d13ab4"
__all__ = ["in_hsts_preload"]

# fmt: off
_GTLD_INCLUDE_SUBDOMAINS = {b'android', b'app', b'bank', b'chrome', b'dev', b'foo', b'gle', b'gmail', b'google', b'hangout', b'insurance', b'meet', b'new', b'page', b'play', b'search', b'youtube'}  # noqa: E501
_JUMPTABLE = [[(0, 11), (11, 5), None, (16, 57), (73, 26), (99, 12), None, (111, 19), (130, 22), (152, 7), (159, 20), (179, 18), None, (197, 22), (219, 45), (264, 7), (271, 9), (280, 36), (316, 10), (326, 10), (336, 21), None, (357, 50), (407, 8), (415, 9), (424, 19), (443, 13), (456, 14), (470, 14), None, None, (484, 29), (513, 16), (529, 35), (564, 14), (578, 24), (602, 9), None, (611, 25), (636, 20), (656, 8), (664, 13), (677, 10), None, (687, 11), (698, 6), (704, 26), (730, 5), (735, 5), (740, 10), (750, 10), (760, 11), (771, 12), (783, 27), None, (810, 11), (821, 11), (832, 7), (839, 29), (868, 18), (886, 27), (913, 46), (959, 25), (984, 16), (1000, 8), (1008, 5), (1013, 22), (1035, 18), None, (1053, 36), (1089, 15), (1104, 8), (1112, 5), None, (1117, 5), (1122, 16), (1138, 14), (1152, 18), None, (1170, 14), (1184, 18), (1202, 48), (1250, 19), (1269, 5), (1274, 46), (1320, 14), (1334, 14), (1348, 20), None, (1368, 10), (1378, 13), (1391, 10), (1401, 19), None, (1420, 13), (1433, 19), (1452, 5), (1457, 4), (1461, 22), (1483, 10), (1493, 7), (1500, 14), (1514, 21), (1535, 11), (1546, 10), (1556, 12), (1568, 32), None, (1600, 10), (1610, 14), (1624, 12), (1636, 45), (1681, 15), None, (1696, 11), (1707, 23), (1730, 21), (1751, 26), (1777, 6), (1783, 6), (1789, 7), (1796, 5), (1801, 20), (1821, 23), (1844, 24), (1868, 13), (1881, 15), (1896, 19), (1915, 6), (1921, 61), (1982, 44), (2026, 12), (2038, 23), (2061, 16), (2077, 38), (2115, 6), (2121, 12), (2133, 44), (2177, 6), (2183, 41), (2224, 13), (2237, 23), (2260, 30), (2290, 16), (2306, 8), (2314, 6), (2320, 12), (2332, 19), (2351, 21), (2372, 15), None, (2387, 35), (2422, 21), (2443, 17), (2460, 19), (2479, 26), (2505, 5), (2510, 37), (2547, 30), (2577, 16), (2593, 10), (2603, 17), (2620, 23), (2643, 14), (2657, 17), (2674, 8), (2682, 4), (2686, 7), (2693, 29), (2722, 6), (2728, 18), (2746, 27), (2773, 20), (2793, 17), (2810, 19), (2829, 12), (2841, 40), (2881, 40), (2921, 12), (2933, 48), (2981, 25), (3006, 12), None, (3018, 8), (3026, 20), (3046, 19), (3065, 6), (3071, 23), None, (3094, 23), (3117, 33), (3150, 14), (3164, 12), (3176, 27), None, (3203, 26), (3229, 31), (3260, 50), (3310, 15), (3325, 20), (3345, 15), (3360, 21), (3381, 32), (3413, 24), (3437, 20), (3457, 13), (3470, 60), (3530, 19), (3549, 9), (3558, 12), (3570, 12), (3582, 11), (3593, 10), (3603, 48), (3651, 32), None, (3683, 25), (3708, 12), None, (3720, 8), (3728, 8), (3736, 7), None, (3743, 25), (3768, 17), None, (3785, 21), (3806, 35), (3841, 12), (3853, 10), (3863, 36), (3899, 20), (3919, 22), (3941, 23), (3964, 19), (3983, 12), (3995, 5), (4000, 30), (4030, 24), (4054, 14), (4068, 14), (4082, 47), (4129, 46), None, None, (4175, 51), (4226, 42), None, (4268, 14), None, (4282, 15), (4297, 8), (4305, 21), (4326, 6), (4332, 16), (4348, 17)], [(4365, 6112), (10477, 6518), (16995, 6989), (23984, 5855), (29839, 6198), (36037, 5865), (41902, 6849), (48751, 6169), (54920, 6712), (61632, 5969), (67601, 6999), (74600, 6281), (80881, 6658), (87539, 7000), (94539, 6445), (100984, 6390), (107374, 6966), (114340, 5872), (120212, 6202), (126414, 6475), (132889, 6800), (139689, 6481), (146170, 6748), (152918, 6061), (158979, 6115), (165094, 6568), (171662, 6449), (178111, 6737), (184848, 6191), (191039, 6454), (197493, 6788), (204281, 6421), (210702, 6348), (217050, 6960), (224010, 6076), (230086, 6700), (236786, 6142), (242928, 6928), (249856, 6644), (256500, 6899), (263399, 7379), (270778, 6294), (277072, 6254), (283326, 6077), (289403, 6270), (295673, 5963), (301636, 6213), (307849, 6948), (314797, 6264), (321061, 5632), (326693, 6359), (333052, 6529), (339581, 6425), (346006, 6664), (352670, 6744), (359414, 6662), (366076, 6759), (372835, 5817), (378652, 6717), (385369, 5708), (391077, 6531), (397608, 6303), (403911, 6300), (410211, 6778), (416989, 6620), (423609, 6439), (430048, 6078), (436126, 6981), (443107, 6657), (449764, 6744), (456508, 6445), (462953, 6341), (469294, 5683), (474977, 6913), (481890, 6970), (488860, 6798), (495658, 6080), (501738, 7148), (508886, 6902), (515788, 5955), (521743, 6611), (528354, 5672), (534026, 6279), (540305, 6516), (546821, 6401), (553222, 6358), (559580, 6469), (566049, 6615), (572664, 6684), (579348, 6394), (585742, 7112), (592854, 5974), (598828, 6120), (604948, 6470), (611418, 6431), (617849, 7076), (624925, 6768), (631693, 6305), (637998, 6170), (644168, 6075), (650243, 6191), (656434, 6687), (663121, 6103), (669224, 6379), (675603, 6032), (681635, 6767), (688402, 6562), (694964, 6927), (701891, 7924), (709815, 7024), (716839, 6823), (723662, 6393), (730055, 6175), (736230, 6599), (742829, 6845), (749674, 6426), (756100, 6167), (762267, 6340), (768607, 6304), (774911, 6855), (781766, 6686), (788452, 6773), (795225, 6996), (802221, 6729), (808950, 7663), (816613, 6303), (822916, 5682), (828598, 6881), (835479, 6512), (841991, 7867), (849858, 6873), (856731, 6099), (862830, 6688), (869518, 6803), (876321, 6273), (882594, 6660), (889254, 6076), (895330, 6700), (902030, 6382), (908412, 6463), (914875, 6474), (921349, 7146), (928495, 6143), (934638, 6173), (940811, 6498), (947309, 6471), (953780, 6350), (960130, 6722), (966852, 6096), (972948, 7113), (980061, 6559), (986620, 6649), (993269, 6777), (1000046, 6415), (1006461, 6461), (1012922, 6366), (1019288, 6256), (1025544, 6257), (1031801, 6133), (1037934, 5660), (1043594, 6050), (1049644, 6511), (1056155, 7117), (1063272, 5994), (1069266, 6528), (1075794, 6832), (1082626, 6363), (1088989, 6060), (1095049, 6787), (1101836, 6390), (1108226, 5878), (1114104, 6464), (1120568, 7564), (1128132, 5972), (1134104, 6160), (1140264, 6616), (1146880, 6162), (1153042, 6613), (1159655, 6287), (1165942, 5953), (1171895, 7327), (1179222, 6668), (1185890, 6313), (1192203, 6894), (1199097, 7203), (1206300, 7229), (1213529, 6139), (1219668, 6903), (1226571, 6207), (1232778, 6528), (1239306, 6687), (1245993, 6017), (1252010, 6777), (1258787, 6895), (1265682, 6505), (1272187, 6488), (1278675, 6278), (1284953, 6438), (1291391, 6700), (1298091, 6223), (1304314, 6555), (1310869, 5795), (1316664, 7050), (1323714, 6862), (1330576, 6560), (1337136, 6824), (1343960, 5632), (1349592, 6633), (1356225, 6370), (1362595, 6559), (1369154, 6731), (1375885, 7021), (1382906, 6482), (1389388, 6631), (1396019, 6708), (1402727, 6317), (1409044, 6449), (1415493, 6423), (1421916, 6500), (1428416, 6265), (1434681, 6329), (1441010, 5886), (1446896, 7391), (1454287, 6559), (1460846, 6264), (1467110, 6660), (1473770, 6536), (1480306, 5708), (1486014, 6613), (1492627, 6458), (1499085, 7525), (1506610, 6377), (1512987, 5822), (1518809, 6958), (1525767, 6298), (1532065, 7011), (1539076, 6042), (1545118, 6135), (1551253, 5779), (1557032, 6609), (1563641, 6433), (1570074, 6792), (1576866, 6171), (1583037, 6473), (1589510, 6431), (1595941, 6951), (1602892, 6281), (1609173, 5764), (1614937, 6450), (1621387, 6108), (1627495, 6579), (1634074, 6822), (1640896, 7055), (1647951, 6247), (1654198, 6228), (1660426, 6575)], [(1667001, 703), (1667704, 625), (1668329, 628), (1668957, 663), (1669620, 523), (1670143, 633), (1670776, 644), (1671420, 808), (1672228, 640), (1672868, 627), (1673495, 536), (1674031, 544), (1674575, 758), (1675333, 866), (1676199, 955), (1677154, 714), (1677868, 1207), (1679075, 606), (1679681, 875), (1680556, 673), (1681229, 733), (1681962, 708), (1682670, 802), (1683472, 731), (1684203, 684), (1684887, 631), (1685518, 940), (1686458, 1068), (1687526, 791), (1688317, 657), (1688974, 922), (1689896, 787), (1690683, 557), (1691240, 671), (1691911, 732), (1692643, 761), (1693404, 619), (1694023, 688), (1694711, 692), (1695403, 992), (1696395, 683), (1697078, 812), (1697890, 676), (1698566, 689), (1699255, 728), (1699983, 362), (1700345, 763), (1701108, 857), (1701965, 721), (1702686, 525), (1703211, 789), (1704000, 656), (1704656, 763), (1705419, 935), (1706354, 918), (1707272, 483), (1707755, 661), (1708416, 486), (1708902, 578), (1709480, 724), (1710204, 734), (1710938, 753), (1711691, 1008), (1712699, 836), (1713535, 628), (1714163, 692), (1714855, 767), (1715622, 444), (1716066, 561), (1716627, 518), (1717145, 692), (1717837, 802), (1718639, 523), (1719162, 725), (1719887, 634), (1720521, 671), (1721192, 552), (1721744, 680), (1722424, 768), (1723192, 428), (1723620, 672), (1724292, 629), (1724921, 828), (1725749, 623), (1726372, 588), (1726960, 310), (1727270, 597), (1727867, 725), (1728592, 756), (1729348, 676), (1730024, 816), (1730840, 1074), (1731914, 814), (1732728, 773), (1733501, 674), (1734175, 436), (1734611, 971), (1735582, 881), (1736463, 564), (1737027, 580), (1737607, 683), (1738290, 843), (1739133, 839), (1739972, 552), (1740524, 632), (1741156, 740), (1741896, 395), (1742291, 467), (1742758, 924), (1743682, 863), (1744545, 792), (1745337, 774), (1746111, 610), (1746721, 771), (1747492, 643), (1748135, 699), (1748834, 709), (1749543, 433), (1749976, 639), (1750615, 588), (1751203, 914), (1752117, 653), (1752770, 789), (1753559, 404), (1753963, 703), (1754666, 679), (1755345, 835), (1756180, 883), (1757063, 781), (1757844, 904), (1758748, 747), (1759495, 524), (1760019, 757), (1760776, 583), (1761359, 758), (1762117, 732), (1762849, 639), (1763488, 682), (1764170, 589), (1764759, 656), (1765415, 594), (1766009, 691), (1766700, 691), (1767391, 637), (1768028, 437), (1768465, 549), (1769014, 641), (1769655, 556), (1770211, 683), (1770894, 594), (1771488, 761), (1772249, 520), (1772769, 490), (1773259, 656), (1773915, 573), (1774488, 607), (1775095, 639), (1775734, 796), (1776530, 594), (1777124, 609), (1777733, 841), (1778574, 826), (1779400, 522), (1779922, 695), (1780617, 796), (1781413, 632), (1782045, 659), (1782704, 480), (1783184, 609), (1783793, 633), (1784426, 714), (1785140, 598), (1785738, 898), (1786636, 695), (1787331, 794), (1788125, 721), (1788846, 649), (1789495, 566), (1790061, 646), (1790707, 699), (1791406, 1277), (1792683, 514), (1793197, 624), (1793821, 608), (1794429, 962), (1795391, 754), (1796145, 745), (1796890, 546), (1797436, 565), (1798001, 808), (1798809, 553), (1799362, 569), (1799931, 847), (1800778, 650), (1801428, 871), (1802299, 772), (1803071, 668), (1803739, 671), (1804410, 783), (1805193, 620), (1805813, 889), (1806702, 631), (1807333, 722), (1808055, 558), (1808613, 715), (1809328, 449), (1809777, 775), (1810552, 779), (1811331, 648), (1811979, 901), (1812880, 775), (1813655, 790), (1814445, 903), (1815348, 1077), (1816425, 815), (1817240, 586), (1817826, 854), (1818680, 677), (1819357, 483), (1819840, 443), (1820283, 692), (1820975, 749), (1821724, 406), (1822130, 974), (1823104, 462), (1823566, 758), (1824324, 863), (1825187, 712), (1825899, 769), (1826668, 647), (1827315, 762), (1828077, 715), (1828792, 768), (1829560, 608), (1830168, 566), (1830734, 408), (1831142, 622), (1831764, 437), (1832201, 767), (1832968, 815), (1833783, 764), (1834547, 718), (1835265, 621), (1835886, 568), (1836454, 848), (1837302, 440), (1837742, 590), (1838332, 780), (1839112, 494), (1839606, 847), (1840453, 2071), (1842524, 527), (1843051, 627), (1843678, 875), (1844553, 851), (1845404, 510)], [(1845914, 48), None, (1845962, 35), (1845997, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (1846039, 42), None, (1846081, 25), (1846106, 16), None, None, None, None, None, None, (1846122, 26), None, None, None, None, (1846148, 21), (1846169, 25), None, None, (1846194, 26), None, None, None, None, (1846220, 44), (1846264, 21), (1846285, 23), None, None, None, None, (1846308, 48), None, None, None, None, None, (1846356, 31), None, None, None, None, (1846387, 42), None, (1846429, 22), None, (1846451, 21), None, (1846472, 26), (1846498, 42), None, None, (1846540, 77), None, None, None, None, None, (1846617, 21), (1846638, 21), None, None, (1846659, 34), (1846693, 42), None, None, None, (1846735, 25), None, None, (1846760, 21), None, None, None, None, None, (1846781, 24), (1846805, 21), None, None, (1846826, 26), None, (1846852, 18), None, (1846870, 54), None, None, None, None, None, None, (1846924, 26), None, (1846950, 19), None, (1846969, 20), None, None, (1846989, 42), (1847031, 42), (1847073, 17), None, (1847090, 26), None, (1847116, 26), None, None, None, (1847142, 26), (1847168, 20), (1847188, 26), None, (1847214, 42), (1847256, 63), None, None, None, (1847319, 40), (1847359, 48), None, None, None, (1847407, 47), None, None, None, None, None, None, None, (1847454, 42), None, (1847496, 55), None, (1847551, 9), None, (1847560, 21), (1847581, 42), None, None, (1847623, 42), (1847665, 82), None, None, (1847747, 42), None, None, None, None, None, None, None, None, None, (1847789, 42), (1847831, 21), (1847852, 21), None, (1847873, 42), (1847915, 25), None, None, (1847940, 21), (1847961, 42), None, None, (1848003, 21), (1848024, 19), (1848043, 26), None, None, None, (1848069, 21), None, None, (1848090, 38), None, (1848128, 22), (1848150, 21), (1848171, 21), None, None, (1848192, 63), None, (1848255, 21), (1848276, 42), None, (1848318, 17), None, None, None, None, (1848335, 21), (1848356, 21), None, None, (1848377, 21), None, None, (1848398, 21), None, (1848419, 26), None, (1848445, 50), None, None, None, (1848495, 50), (1848545, 26), (1848571, 21), (1848592, 21), (1848613, 19), None, (1848632, 35), (1848667, 26), (1848693, 23), (1848716, 21), (1848737, 42), None, None, None, None, None, None, (1848779, 21), None, None, None, (1848800, 21), None, None, (1848821, 90), None, (1848911, 239), (1849150, 38), None, None, None, None]]  # noqa: E501
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40


try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path), "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
