<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Parameter Estimation in Dynamic Models &#8212; BIP - Bayesian Inference with Python 0.6.12 documentation</title>
    
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.6.12',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Stochastic Differential Equations" href="sde.html" />
    <link rel="prev" title="Overview" href="overview.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="sde.html" title="Stochastic Differential Equations"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="overview.html" title="Overview"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">BIP</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/BIP.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Parameter Estimation in Dynamic Models</a><ul>
<li><a class="reference internal" href="#single-session-retrospective-estimation">Single Session Retrospective estimation</a><ul>
<li><a class="reference internal" href="#example-usage">Example Usage</a></li>
<li><a class="reference internal" href="#stochastic-model-example">Stochastic Model Example</a></li>
</ul>
</li>
<li><a class="reference internal" href="#iterative-estimation-and-forecast">Iterative Estimation and Forecast</a></li>
<li><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="overview.html"
                        title="previous chapter">Overview</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="sde.html"
                        title="next chapter">Stochastic Differential Equations</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/paramest.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="parameter-estimation-in-dynamic-models">
<h1>Parameter Estimation in Dynamic Models<a class="headerlink" href="#parameter-estimation-in-dynamic-models" title="Permalink to this headline">¶</a></h1>
<p>A growing theme in mathematical modeling is uncertainty analysis. The Melding Module provides a Bayesian framework to analyze uncertainty in mathematical models. It includes tools that allow modellers to integrate Prior information about the model&#8217;s parameters and variables into the model, in order to explore the full uncertainty associated with a model.</p>
<p>This framework is inspired on the original Bayesian Melding paper by Poole and Raftery <a class="footnote-reference" href="#id5" id="id1">[2]</a>, but extended to handle dynamical systems and different posterior sampling mechanisms, i.e., the user has the choice to use Sampling Importance resampling, Approximate Bayesian computations or MCMC. A deeper description of the methodology implemented in this package is available as published research paper <a class="footnote-reference" href="#id4" id="id2">[1]</a>. This paper also contains a more extensive example of parameter estimation. If you intend to use this package for a scientific publication, you should cite this paper <a class="footnote-reference" href="#id4" id="id3">[1]</a>.</p>
<p>Once a model is thus parameterized, we can simulate the model, with full uncertainty representation and also fit the model to available data to reduce that uncertaity. Markov chain Monte Carlo algorithms are at the core of the framework, which requires a large number of simulations of the models in order to explore parameter space.</p>
<div class="section" id="single-session-retrospective-estimation">
<h2>Single Session Retrospective estimation<a class="headerlink" href="#single-session-retrospective-estimation" title="Permalink to this headline">¶</a></h2>
<p>Frequently, we have a complete time series corresponding to one or more state variables of our dynamic model. In such cases it may be interesting to use this information, to estimate the parameter values which maximize the fit of our model to the data. Below are examples of such inference situations.</p>
<div class="section" id="example-usage">
<h3>Example Usage<a class="headerlink" href="#example-usage" title="Permalink to this headline">¶</a></h3>
<p>This first example includes a simple ODE (an SIR epidemic model) model which is fitted against simulated data to which noise is added:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Parameter estimation and series forcasting based on simulated data with moving window.</span>
<span class="sd">Deterministic model</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="c1">#</span>
<span class="c1"># Copyright 2009- by Flávio Codeço Coelho</span>
<span class="c1"># License gpl v3</span>
<span class="c1">#</span>
<span class="kn">from</span> <span class="nn">BIP.Bayes.Melding</span> <span class="k">import</span> <span class="n">FitModel</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="k">import</span> <span class="n">odeint</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">st</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">beta</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Transmission coefficient</span>
<span class="n">tau</span> <span class="o">=</span> <span class="o">.</span><span class="mi">2</span>  <span class="c1"># infectious period. FIXED</span>
<span class="n">tf</span> <span class="o">=</span> <span class="mi">36</span>
<span class="n">y0</span> <span class="o">=</span> <span class="p">[</span><span class="o">.</span><span class="mi">999</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="n">theta</span><span class="p">):</span>
    <span class="n">beta</span><span class="p">,</span> <span class="n">tau</span> <span class="o">=</span> <span class="n">theta</span>

    <span class="k">def</span> <span class="nf">sir</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;ODE model&#39;&#39;&#39;</span>
        <span class="n">S</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">y</span>
        <span class="k">return</span> <span class="p">[</span><span class="o">-</span><span class="n">beta</span> <span class="o">*</span> <span class="n">I</span> <span class="o">*</span> <span class="n">S</span><span class="p">,</span>  <span class="c1"># dS/dt</span>
                <span class="n">beta</span> <span class="o">*</span> <span class="n">I</span> <span class="o">*</span> <span class="n">S</span> <span class="o">-</span> <span class="n">tau</span> <span class="o">*</span> <span class="n">I</span><span class="p">,</span>  <span class="c1"># dI/dt</span>
                <span class="n">tau</span> <span class="o">*</span> <span class="n">I</span><span class="p">]</span>  <span class="c1"># dR/dt</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">sir</span><span class="p">,</span> <span class="n">inits</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tf</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">y</span>


<span class="n">F</span> <span class="o">=</span> <span class="n">FitModel</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">tf</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;tau&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">],</span>
             <span class="n">wl</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span> <span class="n">nw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">F</span><span class="o">.</span><span class="n">set_priors</span><span class="p">(</span><span class="n">tdists</span><span class="o">=</span><span class="p">[</span><span class="n">st</span><span class="o">.</span><span class="n">norm</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">norm</span><span class="p">],</span> <span class="n">tpars</span><span class="o">=</span><span class="p">[(</span><span class="mf">1.1</span><span class="p">,</span> <span class="o">.</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="o">.</span><span class="mi">2</span><span class="p">,</span> <span class="o">.</span><span class="mi">1</span><span class="p">)],</span> <span class="n">tlims</span><span class="o">=</span><span class="p">[(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span>
             <span class="n">pdists</span><span class="o">=</span><span class="p">[</span><span class="n">st</span><span class="o">.</span><span class="n">uniform</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ppars</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="o">.</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">.</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">.</span><span class="mi">8</span><span class="p">,</span> <span class="o">.</span><span class="mi">2</span><span class="p">)],</span> <span class="n">plims</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">model</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">.</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># simulate some data</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span>
<span class="n">dt</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="n">d</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">noise</span><span class="p">}</span>  <span class="c1"># add noise</span>
<span class="n">F</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;DREAM&#39;</span><span class="p">,</span> <span class="n">likvar</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">pool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">monitor</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span class="n">likfun</span><span class="o">=</span><span class="s1">&#39;Normal&#39;</span><span class="p">)</span>
<span class="c1"># ==Uncomment the line below to see plots of the results</span>
<span class="n">F</span><span class="o">.</span><span class="n">plot_results</span><span class="p">()</span>
</pre></div>
</div>
<p>The code above starts by defining the models parameters and initial conditions, and a function which takes in the parameters runs the model and returns the output.</p>
<p>After that, we Instantiate our fitting Object:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">F</span> <span class="o">=</span> <span class="n">FitModel</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">tf</span><span class="p">,[</span><span class="s1">&#39;beta&#39;</span><span class="p">],[</span><span class="s1">&#39;S&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;R&#39;</span><span class="p">],</span>
            <span class="n">wl</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span><span class="n">nw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">burnin</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<p>Here we have to pass a few arguments: the first (<code class="docutils literal"><span class="pre">K=300</span></code>) is the number of samples we will take from the joint prior distribution of the parameters to run the inference. The second one (<code class="docutils literal"><span class="pre">model</span></code>) is the callable(function) which corresponds to the model you want to fit to data. Then you have the initial condition vector(<code class="docutils literal"><span class="pre">inits=y0</span></code>), the list of parameter names (<code class="docutils literal"><span class="pre">thetanames</span> <span class="pre">=</span> <span class="pre">['beta']</span></code>), the list of variable names (<code class="docutils literal"><span class="pre">phinames=['S','I','R']</span></code>), inference window length (<code class="docutils literal"><span class="pre">wl=36</span></code>), number of juxtaposed windows (<code class="docutils literal"><span class="pre">nw=1</span></code>), verbosity flag (<code class="docutils literal"><span class="pre">verbose=False</span></code>) and finally the number of burnin samples (<code class="docutils literal"><span class="pre">burnin=1000</span></code>), which is only needed for if the inference method chosen is <code class="docutils literal"><span class="pre">MCMC</span></code>.</p>
<p>One should always have <code class="docutils literal"><span class="pre">verbose=True</span></code> on a first fitting run of a model or if the simulations seems to be taking longer than expected. When <code class="docutils literal"><span class="pre">verbose</span></code> is true, printed and graphical is generated regarding the behavior of fitting, which can be useful to fine tune its parameters.</p>
<p>The next line of code also carries a lot of relevant information about the inference: the specification of the prior distributions. By now you must have noticed that not all parameters included in the model need to be included in the analysis. any number of them except for one can be set constant, which is what happens with the parameter <code class="docutils literal"><span class="pre">tau</span></code> in this example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">F</span><span class="o">.</span><span class="n">set_priors</span><span class="p">(</span><span class="n">tdists</span><span class="o">=</span><span class="p">[</span><span class="n">st</span><span class="o">.</span><span class="n">norm</span><span class="p">],</span><span class="n">tpars</span><span class="o">=</span><span class="p">[(</span><span class="mf">1.1</span><span class="p">,</span><span class="o">.</span><span class="mi">2</span><span class="p">)],</span><span class="n">tlims</span><span class="o">=</span><span class="p">[(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">1.5</span><span class="p">)],</span>
    <span class="n">pdists</span><span class="o">=</span><span class="p">[</span><span class="n">st</span><span class="o">.</span><span class="n">uniform</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span><span class="n">ppars</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="o">.</span><span class="mi">1</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="o">.</span><span class="mi">1</span><span class="p">),(</span><span class="o">.</span><span class="mi">8</span><span class="p">,</span><span class="o">.</span><span class="mi">2</span><span class="p">)],</span><span class="n">plims</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p>here we set the prior distributions for the theta (the model&#8217;s parameters) and phi (the model&#8217;s variables). <code class="docutils literal"><span class="pre">tdists</span></code>, <code class="docutils literal"><span class="pre">tpars</span></code> and <code class="docutils literal"><span class="pre">tlims</span></code> are theta&#8217;s distributions, parameters, and ranges. For example here we use a Normal distribution (<code class="docutils literal"><span class="pre">st.norm</span></code>) for <code class="docutils literal"><span class="pre">beta</span></code>, with mean and standard deviation equal to 1.1 and .2, respectively. we also set the range of <code class="docutils literal"><span class="pre">beta</span></code> to be from 0.5 to 1.5. We do the same for phi.</p>
<p>The remaining lines just generate some simulated data to fit the model with, run the inference and plot the results which should include plots like this:</p>
<div class="figure" id="id6">
<a class="reference internal image-reference" href="_images/fit_series.png"><img alt="_images/fit_series.png" src="_images/fit_series.png" style="width: 15cm;" /></a>
<p class="caption"><span class="caption-text">Series posterior distributions. Colored areas represent 95% credible intervals.</span></p>
</div>
<div class="figure" id="id7">
<a class="reference internal image-reference" href="_images/fit_par.png"><img alt="_images/fit_par.png" src="_images/fit_par.png" style="width: 15cm;" /></a>
<p class="caption"><span class="caption-text">Parameters prior and posterior distributions.</span></p>
</div>
<p>One important argument in the run call, is the likvar, Which is the initial value for the likelihood variance. Try to increase its value if the acceptance ratio of the markov chain is too llow. Ideal levels for the acceptance ratio should be between 0.3 and 0.5.</p>
<p>The code for the above example can be found in the examples directory of the BIP distribution as <a class="reference download internal" href="_downloads/deterministic.py" download=""><code class="xref download docutils literal"><span class="pre">deterministic.py</span></code></a></p>
</div>
<div class="section" id="stochastic-model-example">
<h3>Stochastic Model Example<a class="headerlink" href="#stochastic-model-example" title="Permalink to this headline">¶</a></h3>
<p>This example fits a stochastic model to simulated data. It uses the <a class="reference internal" href="sde.html#sde"><span class="std std-ref">SDE</span></a> package of BIP:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># -*- coding:utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Parameter estimation and series forcasting based on simulated data with moving window.</span>
<span class="sd">Stochastic model</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="c1">#</span>
<span class="c1"># Copyright 2009- by Flávio Codeço Coelho</span>
<span class="c1"># License gpl v3</span>
<span class="c1">#</span>
<span class="kn">from</span> <span class="nn">BIP.SDE.gillespie</span> <span class="k">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">BIP.Bayes.Melding</span> <span class="k">import</span> <span class="n">FitModel</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">stats</span> <span class="k">as</span> <span class="n">st</span>

<span class="n">mu</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># birth and death rate.FIXED</span>
<span class="n">beta</span> <span class="o">=</span> <span class="mf">0.00058</span>  <span class="c1"># Transmission rate</span>
<span class="n">eta</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span>  <span class="c1"># infectivity of asymptomatic infections relative to clinical ones. FIXED</span>
<span class="n">epsilon</span> <span class="o">=</span> <span class="o">.</span><span class="mi">1</span>  <span class="c1"># latency period</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="o">.</span><span class="mi">2</span>  <span class="c1"># Probability of developing clinical influenza symptoms</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span>  <span class="c1"># reduced risk of re-infection after recovery</span>
<span class="n">tau</span> <span class="o">=</span> <span class="o">.</span><span class="mi">01</span>  <span class="c1"># infectious period. FIXED</span>
<span class="c1"># Initial conditions</span>
<span class="k">global</span> <span class="n">inits</span><span class="p">,</span> <span class="n">tf</span>
<span class="n">tf</span> <span class="o">=</span> <span class="mi">140</span>
<span class="n">inits</span> <span class="o">=</span> <span class="p">[</span><span class="mi">490</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">pars</span> <span class="o">=</span> <span class="p">[</span><span class="n">beta</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">sigma</span><span class="p">]</span>


<span class="c1"># propensity functions</span>
<span class="k">def</span> <span class="nf">f1</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">inits</span><span class="p">):</span> <span class="k">return</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">inits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">inits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">inits</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># S-&gt;E</span>


<span class="k">def</span> <span class="nf">f2</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">inits</span><span class="p">):</span> <span class="k">return</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">inits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># E-&gt;I</span>


<span class="k">def</span> <span class="nf">f3</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">inits</span><span class="p">):</span> <span class="k">return</span> <span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">inits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># I-&gt;R</span>


<span class="k">def</span> <span class="nf">f4</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">inits</span><span class="p">):</span> <span class="k">return</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">inits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># E-&gt;A</span>


<span class="k">def</span> <span class="nf">f5</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">inits</span><span class="p">):</span> <span class="k">return</span> <span class="n">r</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">inits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># A-&gt;R</span>


<span class="k">def</span> <span class="nf">runModel</span><span class="p">(</span><span class="n">theta</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">tf</span><span class="p">,</span> <span class="n">inits</span>
    <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># setting parameters</span>
    <span class="n">beta</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">vnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">]</span>
    <span class="c1"># rates: b,ki,ka,ri,ra</span>
    <span class="c1"># r = (0.001, 0.1, 0.1, 0.01, 0.01)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">epsilon</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
    <span class="c1"># print r,inits</span>
    <span class="c1"># propensity functions</span>
    <span class="n">propf</span> <span class="o">=</span> <span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">f3</span><span class="p">,</span> <span class="n">f4</span><span class="p">,</span> <span class="n">f5</span><span class="p">)</span>

    <span class="n">tmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                     <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                     <span class="p">])</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">vnames</span><span class="o">=</span><span class="n">vnames</span><span class="p">,</span> <span class="n">rates</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">inits</span><span class="o">=</span><span class="n">inits</span><span class="p">,</span> <span class="n">tmat</span><span class="o">=</span><span class="n">tmat</span><span class="p">,</span> <span class="n">propensity</span><span class="o">=</span><span class="n">propf</span><span class="p">)</span>
    <span class="c1"># t0 = time.time()</span>
    <span class="n">M</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tmax</span><span class="o">=</span><span class="n">tf</span><span class="p">,</span> <span class="n">reps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">viz</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">serial</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">series</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">events</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">getStats</span><span class="p">()</span>
    <span class="n">ser</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># print series.shape, ser.shape</span>
    <span class="k">return</span> <span class="n">ser</span>


<span class="n">d</span> <span class="o">=</span> <span class="n">runModel</span><span class="p">([</span><span class="n">beta</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">sigma</span><span class="p">])</span>
<span class="c1"># ~ import pylab as P</span>
<span class="c1"># ~ P.plot(d)</span>
<span class="c1"># ~ P.show()</span>

<span class="n">dt</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="n">d</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="n">d</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="n">d</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="n">d</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="n">d</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]}</span>
<span class="n">F</span> <span class="o">=</span> <span class="n">FitModel</span><span class="p">(</span><span class="mi">900</span><span class="p">,</span> <span class="n">runModel</span><span class="p">,</span> <span class="n">inits</span><span class="p">,</span> <span class="n">tf</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">],</span>
             <span class="n">wl</span><span class="o">=</span><span class="mi">140</span><span class="p">,</span> <span class="n">nw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">F</span><span class="o">.</span><span class="n">set_priors</span><span class="p">(</span><span class="n">tdists</span><span class="o">=</span><span class="p">[</span><span class="n">st</span><span class="o">.</span><span class="n">uniform</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">tpars</span><span class="o">=</span><span class="p">[(</span><span class="mf">0.00001</span><span class="p">,</span> <span class="o">.</span><span class="mi">0006</span><span class="p">),</span> <span class="p">(</span><span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0006</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span>
             <span class="n">tlims</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="o">.</span><span class="mi">001</span><span class="p">),</span> <span class="p">(</span><span class="o">.</span><span class="mi">001</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span>
             <span class="n">pdists</span><span class="o">=</span><span class="p">[</span><span class="n">st</span><span class="o">.</span><span class="n">uniform</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="n">ppars</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="n">plims</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>

<span class="n">F</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;MCMC&#39;</span><span class="p">,</span> <span class="n">likvar</span><span class="o">=</span><span class="mf">1e1</span><span class="p">,</span> <span class="n">pool</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">monitor</span><span class="o">=</span><span class="p">[])</span>
<span class="c1"># ~ print F.optimize(data=dt,p0=[0.1,.5,.1], optimizer=&#39;oo&#39;,tol=1e-55, verbose=1, plot=1)</span>
<span class="c1"># ==Uncomment the line below to see plots of the results</span>
<span class="n">F</span><span class="o">.</span><span class="n">plot_results</span><span class="p">()</span>
</pre></div>
</div>
<p>This example can be found in the examples folder of BIP under the name of <a class="reference download internal" href="_downloads/flu_stochastic.py" download=""><code class="xref download docutils literal"><span class="pre">flu_stochastic.py</span></code></a>.</p>
</div>
</div>
<div class="section" id="iterative-estimation-and-forecast">
<h2>Iterative Estimation and Forecast<a class="headerlink" href="#iterative-estimation-and-forecast" title="Permalink to this headline">¶</a></h2>
<p>In some other types of application, one&#8217;s data accrue gradually and it may be interesting to use newly available data to improve previously obtained parameter estimations.</p>
<p>Here we envision two types of scenarios: one assuming constant parameters and another where parameter values can actually vary with time. These two scenarios lead to the two fitting strategies depicted on figure</p>
<div class="figure" id="id8">
<a class="reference internal image-reference" href="_images/Inference_scenarios2.png"><img alt="_images/Inference_scenarios2.png" src="_images/Inference_scenarios2.png" style="width: 15cm;" /></a>
<p class="caption"><span class="caption-text">Fitting scenarios: Moving windows and expanding windows.</span></p>
</div>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td><em>(<a class="fn-backref" href="#id2">1</a>, <a class="fn-backref" href="#id3">2</a>)</em> Coelho FC, Codeço CT, Gomes MGM (2011) A Bayesian Framework for Parameter Estimation in Dynamical Models. PLoS ONE 6(5): e19616. doi:10.1371/journal.pone.0019616</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[2]</a></td><td>Poole, D., &amp; Raftery, A. E. (2000). Inference for Deterministic Simulation Models: The Bayesian Melding Approach. Journal of the American Statistical Association, 95(452), 1244-1255. doi:10.2307/2669764</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="sde.html" title="Stochastic Differential Equations"
             >next</a> |</li>
        <li class="right" >
          <a href="overview.html" title="Overview"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">BIP</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2010-14, Flávio Codeço Coelho.
      Last updated on Mar 31, 2017.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.3.
    </div>
  </body>
</html>