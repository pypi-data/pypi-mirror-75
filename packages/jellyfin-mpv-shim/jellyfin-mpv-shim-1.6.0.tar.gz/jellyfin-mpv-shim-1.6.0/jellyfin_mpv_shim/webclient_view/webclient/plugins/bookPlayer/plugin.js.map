{"version":3,"sources":["plugins/bookPlayer/plugin.js"],"names":["define","_exports","_connectionManager","_loading","_keyboardnavigation","_dialogHelper","_events","_style","_materialIcons","_paperIconButtonLight","_tableOfContents","_interopRequireDefault","obj","__esModule","default","asyncGeneratorStep","gen","resolve","reject","_next","_throw","key","arg","info","value","error","done","Promise","then","_asyncToGenerator","fn","self","this","args","arguments","apply","err","undefined","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","BookPlayer","_classCallCheck","instance","Constructor","TypeError","name","type","id","priority","onDialogClosed","bind","openTableOfContents","onWindowKeyUp","_createClass","protoProps","staticProps","prototype","play","options","_progress","_loaded","loading","show","elem","createMediaElement","setCurrentSrc","stop","unbindEvents","_mediaElement","tocElement","_tocElement","rendition","_rendition","dialogHelper","close","destroy","hide","_cancellationToken","shouldCancel","currentItem","_currentItem","currentTime","duration","getBufferedRanges","start","end","volume","isMuted","paused","seekable","e","keyboardnavigation","getKeyName","book","package","metadata","direction","prev","next","bindMediaElementEvents","addEventListener","once","querySelector","bindEvents","document","on","unbindMediaElementEvents","removeEventListener","off","TableOfContents","getElementById","createDialog","exitAnimationDuration","size","autoFocus","scrollY","exitAnimation","removeOnClose","innerHTML","html","open","_this","item","items","streamInfo","started","ended","mediaSource","Id","serverId","ServerId","apiClient","connectionManager","getApiClient","require","epubjs","downloadHref","getItemDownloadUrl","openAs","renderTo","width","height","_currentSrc","cancellationToken","display","epubElem","style","locations","generate","regeneratorRuntime","mark","_callee","percentageTicks","resumeLocation","wrap","_callee$","_context","abrupt","startPositionTicks","cfiFromPercentage","percentageFromCfi","cfi","events","trigger","console","canPlayMediaType","mediaType","toLowerCase","canPlayItem","Path","endsWith","_default"],"mappings":"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","file":"plugin.js","sourcesContent":["import connectionManager from 'connectionManager';\nimport loading from 'loading';\nimport keyboardnavigation from 'keyboardnavigation';\nimport dialogHelper from 'dialogHelper';\nimport events from 'events';\nimport 'css!./style';\nimport 'material-icons';\nimport 'paper-icon-button-light';\n\nimport TableOfContents from './tableOfContents';\n\nexport class BookPlayer {\n    constructor() {\n        this.name = 'Book Player';\n        this.type = 'mediaplayer';\n        this.id = 'bookplayer';\n        this.priority = 1;\n\n        this.onDialogClosed = this.onDialogClosed.bind(this);\n        this.openTableOfContents = this.openTableOfContents.bind(this);\n        this.onWindowKeyUp = this.onWindowKeyUp.bind(this);\n    }\n\n    play(options) {\n        this._progress = 0;\n        this._loaded = false;\n\n        loading.show();\n        let elem = this.createMediaElement();\n        return this.setCurrentSrc(elem, options);\n    }\n\n    stop() {\n        this.unbindEvents();\n\n        let elem = this._mediaElement;\n        let tocElement = this._tocElement;\n        let rendition = this._rendition;\n\n        if (elem) {\n            dialogHelper.close(elem);\n            this._mediaElement = null;\n        }\n\n        if (tocElement) {\n            tocElement.destroy();\n            this._tocElement = null;\n        }\n\n        if (rendition) {\n            rendition.destroy();\n        }\n\n        // Hide loader in case player was not fully loaded yet\n        loading.hide();\n        this._cancellationToken.shouldCancel = true;\n    }\n\n    currentItem() {\n        return this._currentItem;\n    }\n\n    currentTime() {\n        return this._progress * 1000;\n    }\n\n    duration() {\n        return 1000;\n    }\n\n    getBufferedRanges() {\n        return [{\n            start: 0,\n            end: 10000000\n        }];\n    }\n\n    volume() {\n        return 100;\n    }\n\n    isMuted() {\n        return false;\n    }\n\n    paused() {\n        return false;\n    }\n\n    seekable() {\n        return true;\n    }\n\n    onWindowKeyUp(e) {\n        let key = keyboardnavigation.getKeyName(e);\n        let rendition = this._rendition;\n        let book = rendition.book;\n\n        switch (key) {\n            case 'l':\n            case 'ArrowRight':\n            case 'Right':\n                if (this._loaded) {\n                    book.package.metadata.direction === 'rtl' ? rendition.prev() : rendition.next();\n                }\n                break;\n            case 'j':\n            case 'ArrowLeft':\n            case 'Left':\n                if (this._loaded) {\n                    book.package.metadata.direction === 'rtl' ? rendition.next() : rendition.prev();\n                }\n                break;\n            case 'Escape':\n                if (this._tocElement) {\n                    // Close table of contents on ESC if it is open\n                    this._tocElement.destroy();\n                } else {\n                    // Otherwise stop the entire book player\n                    this.stop();\n                }\n                break;\n        }\n    }\n\n    onDialogClosed() {\n        this.stop();\n    }\n\n    bindMediaElementEvents() {\n        let elem = this._mediaElement;\n\n        elem.addEventListener('close', this.onDialogClosed, {once: true});\n        elem.querySelector('.btnBookplayerExit').addEventListener('click', this.onDialogClosed, {once: true});\n        elem.querySelector('.btnBookplayerToc').addEventListener('click', this.openTableOfContents);\n    }\n\n    bindEvents() {\n        this.bindMediaElementEvents();\n\n        document.addEventListener('keyup', this.onWindowKeyUp);\n        // FIXME: I don't really get why document keyup event is not triggered when epub is in focus\n        this._rendition.on('keyup', this.onWindowKeyUp);\n    }\n\n    unbindMediaElementEvents() {\n        let elem = this._mediaElement;\n\n        elem.removeEventListener('close', this.onDialogClosed);\n        elem.querySelector('.btnBookplayerExit').removeEventListener('click', this.onDialogClosed);\n        elem.querySelector('.btnBookplayerToc').removeEventListener('click', this.openTableOfContents);\n    }\n\n    unbindEvents() {\n        if (this._mediaElement) {\n            this.unbindMediaElementEvents();\n        }\n        document.removeEventListener('keyup', this.onWindowKeyUp);\n        if (this._rendition) {\n            this._rendition.off('keyup', this.onWindowKeyUp);\n        }\n    }\n\n    openTableOfContents() {\n        if (this._loaded) {\n            this._tocElement = new TableOfContents(this);\n        }\n    }\n\n    createMediaElement() {\n        let elem = this._mediaElement;\n\n        if (elem) {\n            return elem;\n        }\n\n        elem = document.getElementById('bookPlayer');\n\n        if (!elem) {\n            elem = dialogHelper.createDialog({\n                exitAnimationDuration: 400,\n                size: 'fullscreen',\n                autoFocus: false,\n                scrollY: false,\n                exitAnimation: 'fadeout',\n                removeOnClose: true\n            });\n            elem.id = 'bookPlayer';\n\n            let html = '';\n            html += '<div class=\"topRightActionButtons\">';\n            html += '<button is=\"paper-icon-button-light\" class=\"autoSize bookplayerButton btnBookplayerExit hide-mouse-idle-tv\" tabindex=\"-1\"><i class=\"material-icons bookplayerButtonIcon close\"></i></button>';\n            html += '</div>';\n            html += '<div class=\"topLeftActionButtons\">';\n            html += '<button is=\"paper-icon-button-light\" class=\"autoSize bookplayerButton btnBookplayerToc hide-mouse-idle-tv\" tabindex=\"-1\"><i class=\"material-icons bookplayerButtonIcon toc\"></i></button>';\n            html += '</div>';\n\n            elem.innerHTML = html;\n\n            dialogHelper.open(elem);\n        }\n\n        this._mediaElement = elem;\n\n        return elem;\n    }\n\n    setCurrentSrc(elem, options) {\n        let item = options.items[0];\n        this._currentItem = item;\n        this.streamInfo = {\n            started: true,\n            ended: false,\n            mediaSource: {\n                Id: item.Id\n            }\n        };\n\n        let serverId = item.ServerId;\n        let apiClient = connectionManager.getApiClient(serverId);\n\n        return new Promise((resolve, reject) => {\n            require(['epubjs'], (epubjs) => {\n                let downloadHref = apiClient.getItemDownloadUrl(item.Id);\n                let book = epubjs.default(downloadHref, {openAs: 'epub'});\n                let rendition = book.renderTo(elem, {width: '100%', height: '97%'});\n\n                this._currentSrc = downloadHref;\n                this._rendition = rendition;\n                let cancellationToken = {\n                    shouldCancel: false\n                };\n                this._cancellationToken = cancellationToken;\n\n                return rendition.display().then(() => {\n                    let epubElem = document.querySelector('.epub-container');\n                    epubElem.style.display = 'none';\n\n                    this.bindEvents();\n\n                    return this._rendition.book.locations.generate(1024).then(async () => {\n                        if (cancellationToken.shouldCancel) {\n                            return reject();\n                        }\n\n                        const percentageTicks = options.startPositionTicks / 10000000;\n                        if (percentageTicks !== 0.0) {\n                            const resumeLocation = book.locations.cfiFromPercentage(percentageTicks);\n                            await rendition.display(resumeLocation);\n                        }\n\n                        this._loaded = true;\n                        epubElem.style.display = 'block';\n                        rendition.on('relocated', (locations) => {\n                            this._progress = book.locations.percentageFromCfi(locations.start.cfi);\n\n                            events.trigger(this, 'timeupdate');\n                        });\n\n                        loading.hide();\n\n                        return resolve();\n                    });\n                }, () => {\n                    console.error('Failed to display epub');\n                    return reject();\n                });\n            });\n        });\n    }\n\n    canPlayMediaType(mediaType) {\n        return (mediaType || '').toLowerCase() === 'book';\n    }\n\n    canPlayItem(item) {\n        if (item.Path && (item.Path.endsWith('epub'))) {\n            return true;\n        }\n\n        return false;\n    }\n}\n\nexport default BookPlayer;\n"]}